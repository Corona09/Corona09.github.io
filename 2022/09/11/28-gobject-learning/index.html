<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>GObject Notes | CoronaのBlog</title><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.2"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>GObject Notes</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-09-11T14:34:00.000Z" id="date"> 2022-09-11</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-11-18T14:58:58.343Z" id="updated"> 2022-11-18</time></div></span><br><span>Word Count: <div class="control">1.7k</div></span><br><span>Read Time: <div class="control">7 min</div></span></div></div><hr><div id="post-content"><h1 id="GObject"><a href="#GObject" class="headerlink" title="GObject"></a>GObject</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>GObject 可以理解为一个库, 使用这个库可以用 C 语言编写面向对象的程序.</p>
<p>这里通过一个例子直观地来理解一下 GObject.</p>
<h3 id="定义类"><a href="#定义类" class="headerlink" title="定义类"></a>定义类</h3><p>使用 GObject 时, 变量的命名尽量遵循 <code>&lt;module&gt;_&lt;type&gt;</code> 的前缀, 如当前工程名为 <code>T</code>, 要定义一个类 <code>Integer</code>, 则将该类命名为 <code>TInteger</code>, 并对于各种函数以前缀 <code>t_integer</code> 命名.</p>
<p>首先, 在 GObject 中, 要定义一个「Class」需要两个结构体, 比如, 我要定义一个 <code>TInteger</code> 类, 则需要定义一个结构体 <code>typedef struct _TInteger TInteger</code> 与 <code>typedef struct _TIntegerClass TIntegerClass</code>.</p>
<p>这两者之间的关系比较复杂, 能力有限, 我难以描述清楚. 这里我们只关注如何使用, 而不深究其原理.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> _IntegerClass IntegerClass;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IntegerClass</span> &#123;</span><br>	<span class="hljs-comment">// 将 GObjectClass 作为其第一个成员, 代表继承自 GObject</span><br>	GObjectClass parent_class;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> _Integer Integer;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">Integer</span> &#123;</span><br>	<span class="hljs-comment">// 将 GObject 作为其第一个成员, 代表继承自 GObject</span><br>	GObject parent;<br>	<span class="hljs-comment">// 公开的成员变量</span><br>	<span class="hljs-type">int</span> sex;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="添加-private-属性"><a href="#添加-private-属性" class="headerlink" title="添加 private 属性"></a>添加 private 属性</h3><p>要为一个类添加 private 属性, 需要如下方法:</p>
<p>首先定义一个 <code>TIntegerPrivate</code> 类, 并将所有要设置为 <code>private</code> 的属性放到这里面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">TIntegerPrivate</span> <span class="hljs-title">TIntegerPrivate</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">TIntegerPrivate</span> &#123;</span><br>	<span class="hljs-type">int</span> value;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>需要注意的是, GObject 系统添加 private 属性的原理大概是, 在申请每一个类实例的空间时, 额外申请一块 private 的空间并“挂”到实例的空间旁边.</p>
<p>GObject 系统 private 属性的大小有 64K 的限制. 这一限制在 vala 中也有, 因为实际上 vala 编译器就是将 vala 代码“编译”为使用 glib 等实现的 C 语言代码. 因此 vala 中私有属性也无法避免 64K 大小的限制.</p>
<h3 id="注册类型"><a href="#注册类型" class="headerlink" title="注册类型"></a>注册类型</h3><p>无论是否添加 private 属性, 在定义了 <code>TInteger</code>, <code>TIntegerClass</code> 以及可能还有 <code>TIntegerPrivate</code> 之后, 都需要向 GObject 系统注册该类.</p>
<p>首先, 需要定义宏:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_TYPE_INTEGER (t_integer_get_type())</span><br></code></pre></td></tr></table></figure>

<p>如果没有定义 private 属性, 则可以:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// G_TYPE_OBJECT 与 T_TYPE_INTEGER 类似, 是属于 Integer 类父类的</span><br>G_DEFINE_TYPE (TInteger, t_integer, G_TYPE_OBJECT);<br></code></pre></td></tr></table></figure>

<p>如果定义了 private 属性, 则可以:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">G_DEFINE_TYPE_WITH_CODE (TInteger, t_integer, G_TYPE_OBJECT, G_ADD_PRIVATE(TInteger));<br></code></pre></td></tr></table></figure>

<p>该宏会定义一个函数 <code>TIntegerPrivate* t_integer_get_instance_private(TInteger*);</code>, 该函数用于取出其私有属性.</p>
<p>通常将该部分内容写到一个单独的 c 文件中, 来对外隐藏 private 的部分.</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>在注册类型之后, <code>G_DEFINE_TYPE*</code> 宏会声明两个函数 : <code>static void t_integer_init(TInteger*);</code> 与 <code>static void t_integer_class_init(TIntegerClass*);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">t_integer_init</span><span class="hljs-params">(TInteger* i)</span> &#123;<br>	TIntegerPrivate priv = t_integer_get_instance_private(i);<br>	priv-&gt;value = <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">// 如果没有 private, 则直接</span><br>	<span class="hljs-comment">// i-&gt;value = 0;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="一些特殊的宏"><a href="#一些特殊的宏" class="headerlink" title="一些特殊的宏"></a>一些特殊的宏</h2><h3 id="G-DECLARE-FINAL-TYPE"><a href="#G-DECLARE-FINAL-TYPE" class="headerlink" title="G_DECLARE_FINAL_TYPE"></a>G_DECLARE_FINAL_TYPE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">G_DECLARE_FINAL_TYPE (ModuleObjName, module_obj_name, MODULE, OBJ_NAME, ParentName)<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Example:</span><br><span class="hljs-comment"> * G_DECLARE_FINAL_TYPE (TDouble, t_double, T, Double, GObject);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure>

<p>宏 <code>G_DECLARE_FINAL_TYPE</code> 会做以下事情:</p>
<ol>
<li>定义函数 <code>&lt;module&gt;_&lt;objName&gt;_get_type()</code>. 如 <code>t_double_get_type()</code>.</li>
<li>声明了类型 <code>typedef struct _&lt;module&gt;&lt;objName&gt; &lt;module&gt;&lt;objName&gt;</code> 及 <code>typedef struct _&lt;module&gt;&lt;objName&gt;Class &lt;module&gt;&lt;objName&gt;Class</code>. 如 <code>typedef struct _TDouble TDouble</code> 和 <code>struct _TDoubleClass TDoubleClass</code>.</li>
<li>定义宏 <code>&lt;module&gt;_&lt;objName&gt;</code>. 如 <code>T_DOUBLE</code>. 该宏会被展开成为一个函数, 该函数将一个 <code>gpointer*</code> 强制转换为 <code>TDouble*</code>.</li>
<li>定义宏 <code>&lt;module&gt;_IS_&lt;objName&gt;</code>. 如 <code>T_IS_DOUBLE</code>.</li>
</ol>
<p>与 <code>G_DECLARE_FINAL_TYPE</code> 类似的还有 <code>G_DECLARE_DERIVABLE_TYPE</code>, 其区别在于 <code>G_DECLARE_FINAL_TYPE</code> 定义的类不可被继承, 而 <code>G_DECLARE_DERIVABLE_TYPE</code> 声明的类可以被继承, 即再产生子类.</p>
<p><code>G_DECLARE_*_TYPE</code> 类宏与 <code>G_DEFINE_TYPE*</code> 类宏的区别在于, <code>DECLARE</code> 只是做了一些“体力活”, 即将一部分同质化的函数通过宏定义出来, 如 <code>T_IS_INTEGER</code> 等, 但是并没有向 GObject 系统注册该类, 而 <code>DEFINE</code> 类宏是向 GObject 类注册了该类.</p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><p>这里以 <code>TInteger</code> 作为一个例子.</p>
<p><b>t_integer.h</b> :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;glib-object.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __T_INTEGER_H_UCRSVKFT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __T_INTEGER_H_UCRSVKFT</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_TYPE_INTEGER (t_integer_get_type())</span><br><br>G_DECLARE_DERIVABLE_TYPE(TInteger, t_integer, T, INTEGER, GObject);<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">TIntegerClass</span> &#123;</span><br>	GObjectClass parent_class;<br>&#125;;<br><br>TInteger*<br><span class="hljs-title function_">t_integer_new</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span>;<br><br>gboolean<br><span class="hljs-title function_">t_integer_get_value</span><span class="hljs-params">(TInteger *self, <span class="hljs-type">int</span>* value)</span>;<br><br>gboolean<br><span class="hljs-title function_">t_integer_set_value</span><span class="hljs-params">(TInteger *self, <span class="hljs-type">int</span> value)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* end of include guard: __T_INTEGER_H_UCRSVKFT */</span></span><br></code></pre></td></tr></table></figure>

<p><b>t_integer.c</b> :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;t_integer.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">TIntegerPrivate</span> <span class="hljs-title">TIntegerPrivate</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">TIntegerPrivate</span> &#123;</span><br>	<span class="hljs-type">int</span> value;<br>&#125;;<br><br>G_DEFINE_ABSTRACT_TYPE_WITH_PRIVATE(TInteger, t_integer, G_TYPE_OBJECT);<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">t_integer_class_init</span><span class="hljs-params">(TIntegerClass* klass)</span> &#123; &#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">t_integer_init</span><span class="hljs-params">(TInteger* self)</span> &#123;<br>	TIntegerPrivate* priv = t_integer_get_instance_private(self);<br>	priv-&gt;value = <span class="hljs-number">0</span>;<br>&#125;<br><br>TInteger*<br><span class="hljs-title function_">t_integer_new</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> &#123;<br>	TInteger* t_i = g_object_new(T_TYPE_INTEGER, <span class="hljs-literal">NULL</span>);<br>	TIntegerPrivate* priv = t_integer_get_instance_private(t_i);<br>	priv-&gt;value = value;<br>	<span class="hljs-keyword">return</span> t_i;<br>&#125;<br><br>gboolean<br><span class="hljs-title function_">t_integer_get_value</span><span class="hljs-params">(TInteger *self, <span class="hljs-type">int</span>* value)</span> &#123;<br>	g_return_val_if_fail(T_IS_INTEGER(self), FALSE);<br>	TIntegerPrivate* priv = t_integer_get_instance_private(self);<br>	*value = priv-&gt;value;<br>	<span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br>gboolean<br><span class="hljs-title function_">t_integer_set_value</span><span class="hljs-params">(TInteger *self, <span class="hljs-type">int</span> value)</span> &#123;<br>	g_return_val_if_fail(T_IS_INTEGER(self), FALSE);<br>	TIntegerPrivate* priv = t_integer_get_instance_private(self);<br>	priv-&gt;value = value;<br>	<span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="信号机制"><a href="#信号机制" class="headerlink" title="信号机制"></a>信号机制</h2><p>信号机制有点像 java 中的 <code>ActionListener</code>. 通过信号机制, 可以为某个实例注册一个信号, 当触发该信号时, 可以调用相应的回调函数.</p>
<h3 id="信号注册-Signal-Registration"><a href="#信号注册-Signal-Registration" class="headerlink" title="信号注册 (Signal Registration)"></a>信号注册 (Signal Registration)</h3><p>在使用一个信号之前需先使用 <code>g_signal_new</code> 函数注册该信号:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">guint <span class="hljs-title function_">g_signal_new</span><span class="hljs-params">(</span><br><span class="hljs-params">	<span class="hljs-type">const</span> gchar        *signal_name , <span class="hljs-comment">/* 信号名                      */</span></span><br><span class="hljs-params">	GType              itype        , <span class="hljs-comment">/* 要为哪个类注册信号          */</span></span><br><span class="hljs-params">	GSignalFlags       signal_flags , <span class="hljs-comment">/* 信号的 Flag                 */</span></span><br><span class="hljs-params">	guint              class_offset , <span class="hljs-comment">/* 一个偏移量, 设为 0 即可     */</span></span><br><span class="hljs-params">	GSignalAccumulator accumulator  , <span class="hljs-comment">/* 暂时忽略这个参数            */</span></span><br><span class="hljs-params">	gpointer           accu_data    , <span class="hljs-comment">/* 暂时忽略这个参数, 设为NULL  */</span></span><br><span class="hljs-params">	GSignalCMarshaller c_marshaller , <span class="hljs-comment">/* 暂时忽略这个参数            */</span></span><br><span class="hljs-params">	GType              return_type  , <span class="hljs-comment">/* handler 函数的返回类型      */</span></span><br><span class="hljs-params">	guint              n_params     , <span class="hljs-comment">/* handler 函数接收的参数个数  */</span></span><br><span class="hljs-params">	...                               <span class="hljs-comment">/* 如果 n_params 是 0 则不需要 */</span></span><br><span class="hljs-params">	)</span><br></code></pre></td></tr></table></figure>

<p>例如:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_INTEGER_SIGNAL_DIV_BY_ZERO <span class="hljs-string">&quot;div-by-zero&quot;</span></span><br><span class="hljs-type">static</span> guint t_integer_signal_div_by_zero;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">t_integer_class_init</span><span class="hljs-params">(TIntegerClass* klass)</span> &#123;<br>	t_integer_signal_div_by_zero =<br>		g_signal_new(<br>			T_INTEGER_SIGNAL_DIV_BY_ZERO ,<br>			G_TYPE_FROM_CLASS(klass),<br>			G_SIGNAL_RUN_LAST | G_SIGNAL_NO_RECURSE | G_SIGNAL_NO_HOOKS,<br>			<span class="hljs-number">0</span>,<br>			<span class="hljs-literal">NULL</span>,<br>			<span class="hljs-literal">NULL</span>,<br>			<span class="hljs-literal">NULL</span>,<br>			G_TYPE_NONE,<br>			<span class="hljs-number">0</span><br>		);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><b>注意信号的名称有命名规则, 只能使用 ASCII 字符, 用短划线 “-“ 或下划线 “_” 连接, 必须以字母开始, 建议使用短划线连接, 并且短划线与下划线不能混合使用.</b></p>
<h3 id="信号处理-Signal-Handler"><a href="#信号处理-Signal-Handler" class="headerlink" title="信号处理 (Signal Handler)"></a>信号处理 (Signal Handler)</h3><p>定义如下函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">callback_div_by_zero</span><span class="hljs-params">(TInteger* i, gpointer* user_data)</span> &#123;<br>	g_print(<span class="hljs-string">&quot;[ERROR] Div by ZERO!\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="信号释放-Signal-Emission"><a href="#信号释放-Signal-Emission" class="headerlink" title="信号释放 (Signal Emission)"></a>信号释放 (Signal Emission)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">gboolean<br><span class="hljs-title function_">t_integer_div</span><span class="hljs-params">(TInteger *a, TInteger *b, TInteger* result)</span> &#123;<br>	g_return_val_if_fail(T_IS_INTEGER(a) &amp;&amp; T_IS_INTEGER(b) &amp;&amp; T_IS_INTEGER(result), FALSE);<br><br>	<span class="hljs-type">int</span> va, vb;<br>	gboolean ja = t_integer_get_value(a, &amp;va);<br>	gboolean jb = t_integer_get_value(b, &amp;vb);<br>	<span class="hljs-keyword">if</span> (vb == <span class="hljs-number">0</span>) &#123;<br>		g_signal_emit(b, t_integer_signal_div_by_zero, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br>	gboolean jr = t_integer_set_value(result, va / vb);<br>	<span class="hljs-keyword">return</span> ja &amp;&amp; jb &amp;&amp; jr ? TRUE : FALSE;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="信号链接-Signal-Connection"><a href="#信号链接-Signal-Connection" class="headerlink" title="信号链接 (Signal Connection)"></a>信号链接 (Signal Connection)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">g_signal_connect</span><span class="hljs-params">(instance, detailed_signal, c_handler, data)</span>;<br></code></pre></td></tr></table></figure>

<p>如 :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">TInteger*<br><span class="hljs-title function_">t_integer_new</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> &#123;<br>	TInteger* t_i = g_object_new(T_TYPE_INTEGER, <span class="hljs-literal">NULL</span>);<br>	TIntegerPrivate* priv = t_integer_get_instance_private(t_i);<br>	priv-&gt;value = value;<br>	g_signal_connect(t_i, T_INTEGER_SIGNAL_DIV_BY_ZERO, G_CALLBACK( callback_div_by_zero ), <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">return</span> t_i;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="默认-Handler"><a href="#默认-Handler" class="headerlink" title="默认 Handler"></a>默认 Handler</h3><p>有一些信号, 我们希望给他们默认的 Handler, 则可以使用 <code>g_signal_new_class_handler</code> 函数注册信号.<br><code>g_signal_new_class_handler</code> 函数与 <code>g_signal_new</code> 函数的区别在于第四个参数, 在 <code>g_signal_new</code> 函数中, 第四个参数是一个偏移量, 用于在类中按照该偏移量寻找默认 handler 函数, 这样做的缺陷是对于 final 类, 无法在类中定义默认 handler 函数. 而 <code>g_signal_new_class_handler</code> 函数中第四个参数是一个函数, 用以指定为默认 handler.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> guint t_integer_signal_div_by_zero;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">callback_div_by_zero</span><span class="hljs-params">(TInteger* i, gpointer* user_data)</span>; <br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">t_integer_class_init</span><span class="hljs-params">(TIntegerClass* klass)</span> &#123;<br>	t_integer_signal_div_by_zero =<br>		g_signal_new_class_handler(T_INTEGER_SIGNAL_DIV_BY_ZERO ,<br>				G_TYPE_FROM_CLASS(klass),<br>				G_SIGNAL_RUN_LAST | G_SIGNAL_NO_RECURSE | G_SIGNAL_NO_HOOKS,<br>				G_CALLBACK(callback_div_by_zero),<br>				<span class="hljs-literal">NULL</span>,<br>				<span class="hljs-literal">NULL</span>,<br>				<span class="hljs-literal">NULL</span>,<br>				G_TYPE_NONE,<br>				<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在定义了默认 handler 后, 无需再对信号进行连接.</p>
<h3 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h3><p>对于 <code>g_signal_new</code> 与 <code>g_signal_new_class_handler</code> 函数中的第 3 个参数 <code>signal_flags</code>, 有如下选项:</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>G_SIGNAL_RUN_FIRST</code></td>
<td>默认 handler 在所有用户定义 handler 之前运行</td>
</tr>
<tr>
<td><code>G_SIGNAL_RUN_LAST</code></td>
<td>默认 handler 在用户定义的正常 handler 之后运行 (没有被 <code>g_signal_connect_after</code> 连接的)</td>
</tr>
<tr>
<td><code>G_SIGNAL_RUN_CLEANUP</code></td>
<td>默认 handler 在所有用户定义 handler 和之后运行</td>
</tr>
</tbody></table>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><p>有时候, 对于信号的 handler 函数, 需要传递一些参数.</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2022/10/02/29-seafile/">← Next SeaFile 搭建网盘</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2022/08/16/27-deep-learning-note/">深度学习笔记 Prev →</a></div></div></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Corona09">Corona</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#GObject"><span class="toc-number">1.</span> <span class="toc-text">GObject</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%B1%BB"><span class="toc-number">1.1.1.</span> <span class="toc-text">定义类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-private-%E5%B1%9E%E6%80%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text">添加 private 属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">注册类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.4.</span> <span class="toc-text">初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E7%9A%84%E5%AE%8F"><span class="toc-number">1.2.</span> <span class="toc-text">一些特殊的宏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#G-DECLARE-FINAL-TYPE"><span class="toc-number">1.2.1.</span> <span class="toc-text">G_DECLARE_FINAL_TYPE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-number">1.3.</span> <span class="toc-text">一个例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">信号机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%B3%A8%E5%86%8C-Signal-Registration"><span class="toc-number">1.4.1.</span> <span class="toc-text">信号注册 (Signal Registration)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86-Signal-Handler"><span class="toc-number">1.4.2.</span> <span class="toc-text">信号处理 (Signal Handler)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8A%E6%94%BE-Signal-Emission"><span class="toc-number">1.4.3.</span> <span class="toc-text">信号释放 (Signal Emission)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%93%BE%E6%8E%A5-Signal-Connection"><span class="toc-number">1.4.4.</span> <span class="toc-text">信号链接 (Signal Connection)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4-Handler"><span class="toc-number">1.4.5.</span> <span class="toc-text">默认 Handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flags"><span class="toc-number">1.4.6.</span> <span class="toc-text">Flags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.7.</span> <span class="toc-text">参数</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>