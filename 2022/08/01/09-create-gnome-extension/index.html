<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>创建 GNOME EXTENSION | CoronaのBlog</title><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.2"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>创建 GNOME EXTENSION</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-08-01T10:28:00.000Z" id="date"> 2022-08-01</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-11-18T14:58:58.328Z" id="updated"> 2022-11-18</time></div></span><br><span>Word Count: <div class="control">1.3k</div></span><br><span>Read Time: <div class="control">6 min</div></span></div></div><hr><div id="post-content"><h1 id="创建-GNOME-扩展"><a href="#创建-GNOME-扩展" class="headerlink" title="创建 GNOME 扩展"></a>创建 GNOME 扩展</h1><h2 id="Before-Start"><a href="#Before-Start" class="headerlink" title="Before Start"></a>Before Start</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.gnome.org/Projects/GnomeShell/Extensions#Creating_Extensions">Gnome Wiki - Creating Extensions</a></li>
</ul>
<blockquote>
<p>As GNOME Shell and extensions are written in GJS, it is important to understand that GJS is simply <a target="_blank" rel="noopener" href="https://wiki.gnome.org/JavaScript">JavaScript</a> bindings for the existing GNOME platform APIs. This means many of the classes and functions you will use are already documented in the <a target="_blank" rel="noopener" href="https://gjs-docs.gnome.org/">GNOME API documentation</a>.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://gjs-docs.gnome.org/">Gnome API Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://gjs.guide/extensions/">GJS Guide</a></li>
</ul>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>创建一个文件夹, 名称为 <code>activity-logo@corona</code>, 在该文件夹下创建三个文件:</p>
<p><img src="http://corona-oss.oss-cn-qingdao.aliyuncs.com/notes-img/image-20220803161655402.png" alt="image-20220803161655402"></p>
<h3 id="metadata-json"><a href="#metadata-json" class="headerlink" title="metadata.json"></a>metadata.json</h3><p>在<code>metadata.json</code>中填入如下内容, 其中<code>uuid</code>为文件夹的名字.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Change Activity Logo&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;activity-logo&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;shell-version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>		<span class="hljs-string">&quot;42&quot;</span><br>	<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;activity-logo@corona09&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="extension-js"><a href="#extension-js" class="headerlink" title="extension.js"></a>extension.js</h3><p>该文件包含三个主要函数, <code>init</code>, <code>enable</code>和<code>disable</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">St</span> = imports.<span class="hljs-property">gi</span>.<span class="hljs-property">St</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Main</span> = imports.<span class="hljs-property">ui</span>.<span class="hljs-property">main</span>;<br><br><span class="hljs-keyword">let</span> panelButton, panelButtonText;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Init first to prepare extension</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) &#123;<br>    panelButton = <span class="hljs-keyword">new</span> <span class="hljs-title class_">St</span>.<span class="hljs-title class_">Bin</span>(&#123;<br>        <span class="hljs-attr">style_class</span>: <span class="hljs-string">&quot;panel-button&quot;</span><br>    &#125;);<br>    panelButtonText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">St</span>.<span class="hljs-title class_">Label</span>(&#123;<br>        <span class="hljs-attr">style_class</span>: <span class="hljs-string">&quot;panel-button-text&quot;</span>,<br>        <span class="hljs-attr">text</span>: <span class="hljs-string">&quot;fedora&quot;</span><br>    &#125;);<br>    panelButton.<span class="hljs-title function_">set_child</span>(panelButtonText);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * be called when enable the extension</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">enable</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Main</span>.<span class="hljs-property">panel</span>.<span class="hljs-property">_rightBox</span>.<span class="hljs-title function_">insert_child_at_index</span>(panelButton, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * be called when disable the extension</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">disable</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Main</span>.<span class="hljs-property">panel</span>.<span class="hljs-property">_rightBox</span>.<span class="hljs-title function_">remove_child</span>(panelButton);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="stylesheet-css"><a href="#stylesheet-css" class="headerlink" title="stylesheet.css"></a>stylesheet.css</h3><p>在 <code>extension.js</code> 中, 包含有<code>style_class</code> 的字段, 其内容即为与 css 文件对应的 class 名称.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.panel-button-text</span> &#123;<br>    <span class="hljs-attribute">color</span>: yellow;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="展示终端命令的输出"><a href="#展示终端命令的输出" class="headerlink" title="展示终端命令的输出"></a>展示终端命令的输出</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">const St = imports.gi.St;<br>const Main = imports.ui.main;<br>const MainLoop = imports.mainloop;<br>const GLib = imports.gi.GLib;<br><br><span class="hljs-built_in">let</span> panelButton, panelButtonText, <span class="hljs-built_in">timeout</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">setButtonText</span></span>() &#123;<br>    // 如果要使用管道, 则需要 bash -c, 如<br>    // GLib.spawn_command_line_sync(<span class="hljs-string">&#x27;/bin/bash -c &quot;ifconfig -a | grep tun0&quot; &#x27;</span>);<br>    <span class="hljs-built_in">let</span> [ok, output, err, <span class="hljs-built_in">exit</span>] = GLib.spawn_command_line_sync(<span class="hljs-string">&#x27;date&#x27;</span>);<br>    panelButtonText.set_text(output.toString());<br>    <span class="hljs-built_in">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>/**<br> * Init first to prepare extension<br> */<br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">init</span></span>() &#123;<br>    panelButton = new St.Bin(&#123;<br>        style_class: <span class="hljs-string">&quot;panel-button&quot;</span><br>    &#125;);<br>    panelButtonText = new St.Label(&#123;<br>        style_class: <span class="hljs-string">&quot;panel-button-text&quot;</span>,<br>        text: <span class="hljs-string">&quot;fedora&quot;</span><br>    &#125;);<br>    panelButton.set_child(panelButtonText);<br>&#125;<br><br>/**<br> * be called when <span class="hljs-built_in">enable</span> the extension<br> */<br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">enable</span></span>() &#123;<br>    Main.panel._rightBox.insert_child_at_index(panelButton, 1);<br>    <span class="hljs-built_in">timeout</span> = MainLoop.timeout_add_seconds(1.0, setButtonText);<br>&#125;<br><br>/**<br> * be called when <span class="hljs-built_in">disable</span> the extension<br> */<br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">disable</span></span>() &#123;<br>    MainLoop.source_remove(<span class="hljs-built_in">timeout</span>);<br>    Main.panel._rightBox.remove_child(panelButton);<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="查看调试信息"><a href="#查看调试信息" class="headerlink" title="查看调试信息"></a>查看调试信息</h3><p>在<code>extension.js</code>中添加如下代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">log</span>(message);<br><span class="hljs-title function_">print</span>(message); <span class="hljs-comment">// print to stdout</span><br><span class="hljs-title function_">printerr</span>(message); <span class="hljs-comment">// print to stderr</span><br><span class="hljs-comment">// try-catch</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Test Error&#x27;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-title function_">logError</span>(e, <span class="hljs-string">&#x27;ExtensionErr&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="X11"><a href="#X11" class="headerlink" title="X11"></a>X11</h4><p>运行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">journalctl -f -o <span class="hljs-built_in">cat</span> /usr/bin/gnome-shell<br></code></pre></td></tr></table></figure>

<h4 id="Wayland"><a href="#Wayland" class="headerlink" title="Wayland"></a>Wayland</h4><p>运行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dbus-run-session -- gnome-shell --nested --wayland<br></code></pre></td></tr></table></figure>

<p>执行了 <code>journalctl</code> 命令后重启 gnome-shell, 可以看到调试信息:</p>
<img src="http://corona-oss.oss-cn-qingdao.aliyuncs.com/notes-img/image-20220803171751337.png" alt="image-20220803171751337" style="width:900px;" />

<p>或者将扩展从<code>disable</code>切换到<code>enable</code>, 即可在终端的最后看到日志输出.</p>
<h3 id="查看元素属性"><a href="#查看元素属性" class="headerlink" title="查看元素属性"></a>查看元素属性</h3><p><code>alt+F2</code>, 键入 <code>lg</code>, 在窗口左上角有一个按钮, 可以查看界面上各元素的属性, 类似于浏览器的开发者工具.</p>
<img src="http://corona-oss.oss-cn-qingdao.aliyuncs.com/notes-img/image-20220803173014979.png" alt="image-20220803173014979" style="width:900px;" />

<hr>
<h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><h3 id="GSettings"><a href="#GSettings" class="headerlink" title="GSettings"></a>GSettings</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://gjs-docs.gnome.org/gio20-settings/">GSettings</a> provides a simple, extremely fast API for storing application settings, that can also be used by GNOME Shell extensions.</p>
</blockquote>
<h4 id="创建-Schema"><a href="#创建-Schema" class="headerlink" title="创建 Schema"></a>创建 Schema</h4><p>在 <code>activity-logo@corona</code> 文件夹下创建子文件夹 <code>schemas/</code>.</p>
<p>创建文件 <code>schemas/org.gnome.shell.extensions.activity-logo.gschema.xml</code>.</p>
<p>该文件内容如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">schemalist</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;org.gnome.shell.extensions.activity-logo&quot;</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/org/gnome/shell/extensions/activity-logo/&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- See also: https://docs.gtk.org/glib/gvariant-format-strings.html --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;show-indicator&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;b&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">summary</span>&gt;</span>summary<span class="hljs-tag">&lt;/<span class="hljs-name">summary</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>description<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">schemalist</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>其中 <code>type</code> 有如下选项:</p>
<table>
<thead>
<tr>
<th>TypeName</th>
<th>TypeValue</th>
</tr>
</thead>
<tbody><tr>
<td><code>b</code></td>
<td><code>gboolean</code></td>
</tr>
<tr>
<td><code>y</code></td>
<td><code>guchar</code></td>
</tr>
<tr>
<td><code>n</code></td>
<td><code>gint16</code></td>
</tr>
<tr>
<td><code>q</code></td>
<td><code>guint16</code></td>
</tr>
<tr>
<td><code>i</code></td>
<td><code>gint32</code></td>
</tr>
<tr>
<td><code>u</code></td>
<td><code>guint32</code></td>
</tr>
<tr>
<td><code>x</code></td>
<td><code>guint64</code></td>
</tr>
<tr>
<td><code>t</code></td>
<td><code>guint64</code></td>
</tr>
<tr>
<td><code>h</code></td>
<td><code>gint32</code></td>
</tr>
<tr>
<td><code>d</code></td>
<td><code>gdouble</code></td>
</tr>
</tbody></table>
<h4 id="编译-Schema"><a href="#编译-Schema" class="headerlink" title="编译 Schema"></a>编译 Schema</h4><p>进入<code>schemas/</code>文件夹, 使用<code>glib-compile-schemas schemas/</code> 来编译 schema</p>
<p><img src="http://corona-oss.oss-cn-qingdao.aliyuncs.com/notes-img/image-20220803204621466.png" alt="image-20220803204621466"></p>
<h4 id="整合-Schema"><a href="#整合-Schema" class="headerlink" title="整合 Schema"></a>整合 Schema</h4><p>在<code>extension.js</code> 中添加如下片段:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Gio</span> = imports.<span class="hljs-property">gi</span>.<span class="hljs-property">Gio</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ExtensionUtils</span> = imports.<span class="hljs-property">misc</span>.<span class="hljs-property">extensionUtils</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Me</span> = <span class="hljs-title class_">ExtensionUtils</span>.<span class="hljs-title function_">getCurrentExtension</span>();<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSettings</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-title class_">GioSSS</span> = <span class="hljs-title class_">Gio</span>.<span class="hljs-property">SettingsSchemaSource</span>;<br>    <span class="hljs-keyword">let</span> schemaSource = <span class="hljs-title class_">GioSSS</span>.<span class="hljs-title function_">new_from_directory</span>(<br>        <span class="hljs-title class_">Me</span>.<span class="hljs-property">dir</span>.<span class="hljs-title function_">get_child</span>(<span class="hljs-string">&quot;schemas&quot;</span>).<span class="hljs-title function_">get_path</span>(),<br>        <span class="hljs-title class_">GioSSS</span>.<span class="hljs-title function_">get_default</span>(),<br>        <span class="hljs-literal">false</span><br>    );<br>    <br>    <span class="hljs-keyword">let</span> schemaObj = schemaSource.<span class="hljs-title function_">lookup</span>(<span class="hljs-string">&#x27;org.gnome.shell.extensions.activity-logo&#x27;</span>, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (!schemaObj) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Cannot find schemas&#x27;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gio</span>.<span class="hljs-title class_">Settings</span>(&#123;<span class="hljs-attr">settings_schema</span>: schemaObj&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在需要使用设置的地方, 采用如下方式获取/修改设置的值:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> settings = <span class="hljs-title function_">getSettings</span>();<br>    <span class="hljs-comment">// 获取</span><br>    <span class="hljs-keyword">let</span> int_value = settings.<span class="hljs-title function_">get_int</span>(<span class="hljs-string">&#x27;int-key&#x27;</span>);<br>    <span class="hljs-keyword">let</span> settings = <span class="hljs-title function_">getSettings</span>();<br>    <span class="hljs-keyword">let</span> int_value     = settings.<span class="hljs-title function_">get_int</span>(<span class="hljs-string">&#x27;int-key&#x27;</span>);<br>    <span class="hljs-keyword">let</span> double_value  = settings.<span class="hljs-title function_">get_double</span>(<span class="hljs-string">&#x27;double-key&#x27;</span>);<br>    <span class="hljs-keyword">let</span> boolean_value = settings.<span class="hljs-title function_">get_boolean</span>(<span class="hljs-string">&#x27;boolean-key&#x27;</span>);<br>    <span class="hljs-keyword">let</span> string_value  = settings.<span class="hljs-title function_">get_string</span>(<span class="hljs-string">&#x27;string-key&#x27;</span>);<br>    <span class="hljs-keyword">let</span> sarray_value  = settings.<span class="hljs-title function_">get_strv</span>(<span class="hljs-string">&#x27;strv-key&#x27;</span>);<br>    <span class="hljs-keyword">let</span> enum_value    = settings.<span class="hljs-title function_">get_enum</span>(<span class="hljs-string">&#x27;emun-key&#x27;</span>);<br>    <span class="hljs-comment">// 设置</span><br>    settings.<span class="hljs-title function_">set_int</span>(<span class="hljs-string">&#x27;int-key&#x27;</span>, <span class="hljs-number">0</span>);<br>    settings.<span class="hljs-title function_">set_double</span>(<span class="hljs-string">&#x27;double-key&#x27;</span>, <span class="hljs-number">0.0</span>);<br>    settings.<span class="hljs-title function_">set_boolean</span>(<span class="hljs-string">&#x27;boolean-key&#x27;</span>, <span class="hljs-literal">true</span>);<br>    settings.<span class="hljs-title function_">set_string</span>(<span class="hljs-string">&#x27;string-key&#x27;</span>, <span class="hljs-string">&#x27;Corona&#x27;</span>);<br>    settings.<span class="hljs-title function_">set_strv</span>(<span class="hljs-string">&#x27;strv-key&#x27;</span>, [<span class="hljs-string">&#x27;Hello&#x27;</span>, <span class="hljs-string">&#x27;World&#x27;</span>]);<br>    settings.<span class="hljs-title function_">set_enum</span>(<span class="hljs-string">&#x27;enum-key&#x27;</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// 不要使用 nick 来赋值</span><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="设置窗口"><a href="#设置窗口" class="headerlink" title="设置窗口"></a>设置窗口</h3><h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><hr>
<h2 id="翻译"><a href="#翻译" class="headerlink" title="翻译"></a>翻译</h2><p>以<code>example@corona09</code>为例, 在扩展文件夹下创建<code>locale/zh_CN/LC_MESSAGES/</code>文件夹, 在<code>extension.js</code>中添加如下内容: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ExtensionUtils</span> = imports.<span class="hljs-property">misc</span>.<span class="hljs-property">extensionUtils</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Me</span> = <span class="hljs-title class_">ExtensionUtils</span>.<span class="hljs-title function_">getCurrentExtension</span>();<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Gettext</span> = imports.<span class="hljs-property">gettext</span>;<br><br><span class="hljs-title class_">Gettext</span>.<span class="hljs-title function_">bindtextdomain</span>(<span class="hljs-string">&quot;example&quot;</span>, <span class="hljs-title class_">Me</span>.<span class="hljs-property">dir</span>.<span class="hljs-title function_">get_child</span>(<span class="hljs-string">&quot;locale&quot;</span>)).<span class="hljs-title function_">get_path</span>();<br><span class="hljs-title class_">Gettext</span>.<span class="hljs-title function_">textdomain</span>(<span class="hljs-string">&quot;example&quot;</span>);<br><br><span class="hljs-comment">// 使用 gettext 函数来获取文本的翻译</span><br><span class="hljs-keyword">const</span> _ = <span class="hljs-title class_">Gettext</span>.<span class="hljs-property">gettext</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// 如果存在对对应的语言, 则会出处相应的结果, 否则输出原文本</span><br>    <span class="hljs-title function_">log</span>( <span class="hljs-title function_">_</span>(<span class="hljs-string">&quot;Hello World&quot;</span>) );<br>    <span class="hljs-comment">// 根据数字选择文本, 单数选择前一个, 复数选择后一个</span><br>    <span class="hljs-title function_">log</span>( <span class="hljs-title class_">Gettext</span>.<span class="hljs-title function_">ngettext</span>(<span class="hljs-string">&quot;%d item&quot;</span>, <span class="hljs-string">&quot;%d items&quot;</span>, <span class="hljs-number">10</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-string">&quot;%d&quot;</span>, <span class="hljs-number">10</span>) );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>提取所有 js 文件中的字符串:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">xgettext --output=locale/example.pot *.js<br></code></pre></td></tr></table></figure>

<p>编辑生成的<code>example.pot</code>文件, 更改其编码:</p>
<p><img src="http://corona-oss.oss-cn-qingdao.aliyuncs.com/notes-img/image-20220806113300125.png" alt="image-20220806113300125"></p>
<p>在<code>locale/zh_CN/LC_MESSAGES/</code>文件夹下创建中文的翻译文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msginit --locale zh_CN --input locale/example.pot --out locale/zh_CN/LC_MESSAGES/example.po<br></code></pre></td></tr></table></figure>

<p>编译<code>.po</code>文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> locale/zh_CN/LC_MESSAGES/<br>msgfmt example.po --output-file=example.mo<br></code></pre></td></tr></table></figure>

<p>注意在编译之前将<code>example.po</code>的编码设为<code>UTF-8</code>.</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2022/08/13/26-gtk-learning/">← Next GTK 学习笔记</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2022/07/31/25-server-config/">服务器配置 Prev →</a></div></div></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Corona09">Corona</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-GNOME-%E6%89%A9%E5%B1%95"><span class="toc-number">1.</span> <span class="toc-text">创建 GNOME 扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Before-Start"><span class="toc-number">1.1.</span> <span class="toc-text">Before Start</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#metadata-json"><span class="toc-number">1.2.1.</span> <span class="toc-text">metadata.json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#extension-js"><span class="toc-number">1.2.2.</span> <span class="toc-text">extension.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stylesheet-css"><span class="toc-number">1.2.3.</span> <span class="toc-text">stylesheet.css</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA%E7%BB%88%E7%AB%AF%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BE%93%E5%87%BA"><span class="toc-number">1.2.4.</span> <span class="toc-text">展示终端命令的输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%B0%83%E8%AF%95%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.1.</span> <span class="toc-text">查看调试信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#X11"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">X11</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Wayland"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">Wayland</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%85%83%E7%B4%A0%E5%B1%9E%E6%80%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">查看元素属性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GSettings"><span class="toc-number">1.4.1.</span> <span class="toc-text">GSettings</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Schema"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">创建 Schema</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-Schema"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">编译 Schema</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E5%90%88-Schema"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">整合 Schema</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%AA%97%E5%8F%A3"><span class="toc-number">1.4.2.</span> <span class="toc-text">设置窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-1"><span class="toc-number">1.4.3.</span> <span class="toc-text">调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BF%BB%E8%AF%91"><span class="toc-number">1.5.</span> <span class="toc-text">翻译</span></a></li></ol></li></ol></div></div></div><footer><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>